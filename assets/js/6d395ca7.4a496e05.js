"use strict";(self.webpackChunkjakenelson_cloud=self.webpackChunkjakenelson_cloud||[]).push([[6968],{3905:function(e,t,r){r.d(t,{Zo:function(){return p},kt:function(){return d}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),u=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=u(r),d=a,g=m["".concat(l,".").concat(d)]||m[d]||c[d]||i;return r?n.createElement(g,o(o({ref:t},p),{},{components:r})):n.createElement(g,o({ref:t},p))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var u=2;u<i;u++)o[u]=r[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},9382:function(e,t,r){r.r(t),r.d(t,{assets:function(){return l},contentTitle:function(){return o},default:function(){return c},frontMatter:function(){return i},metadata:function(){return s},toc:function(){return u}});var n=r(3117),a=(r(7294),r(3905));const i={slug:"github-enterprise-as-code",title:"Github As Code",authors:["jake"],tags:["github","ghe","terraform"]},o="Github as Code",s={permalink:"/blog/github-enterprise-as-code",editUrl:"https://github.com/Jake-Mok-Nelson/website/tree/main/jakenelson.cloud/blog/02-12-2021-Github-Enterprise-As-Code.mdx",source:"@site/blog/02-12-2021-Github-Enterprise-As-Code.mdx",title:"Github As Code",description:"Status: Work in Progress",date:"2022-07-08T14:29:54.000Z",formattedDate:"July 8, 2022",tags:[{label:"github",permalink:"/blog/tags/github"},{label:"ghe",permalink:"/blog/tags/ghe"},{label:"terraform",permalink:"/blog/tags/terraform"}],readingTime:2.705,truncated:!1,authors:[{name:"Jake Nelson",title:"Lead Cloud Engineer",url:"https://github.com/Jake-Mok-Nelson",key:"jake"}],frontMatter:{slug:"github-enterprise-as-code",title:"Github As Code",authors:["jake"],tags:["github","ghe","terraform"]}},l={authorsImageUrls:[void 0]},u=[{value:"Module/Abstraction Use Cases",id:"moduleabstraction-use-cases",level:2},{value:"Creating Organisations",id:"creating-organisations",level:2},{value:"User / Group Management",id:"user--group-management",level:2},{value:"Creating org admins",id:"creating-org-admins",level:3},{value:"Blocking Users",id:"blocking-users",level:3},{value:"Repository Management",id:"repository-management",level:2},{value:"Enterprise Code Directory Structures",id:"enterprise-code-directory-structures",level:2},{value:"Separate Orgs",id:"separate-orgs",level:3},{value:"Pros",id:"pros",level:4},{value:"Cons",id:"cons",level:4},{value:"Structure",id:"structure",level:4},{value:"CI / CD",id:"ci--cd",level:2},{value:"Pipeline Practices",id:"pipeline-practices",level:3},{value:"Pipeline Authentication",id:"pipeline-authentication",level:3},{value:"Resources",id:"resources",level:2}],p={toc:u};function c(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},(0,a.kt)("strong",{parentName:"p"},"Status:")," Work in Progress"))),(0,a.kt)("p",null,"Having Github managed as code for an entire organisation has several benefits:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"You can define a set of guidelines for creating new resources based on Github best practices. (see resources section)"),(0,a.kt)("li",{parentName:"ul"},"Configuration can be as generic or specific as you need for the case."),(0,a.kt)("li",{parentName:"ul"},"Implementation is declaritive and transparent."),(0,a.kt)("li",{parentName:"ul"},"Largely self-service environment reduces TOIL.")),(0,a.kt)("p",null,"The target of this implementation is large enterprise implementations of Github Enterprise."),(0,a.kt)("h2",{id:"moduleabstraction-use-cases"},"Module/Abstraction Use Cases"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Organisation group/user management (membership)",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Handle sync groups or static groups"),(0,a.kt)("li",{parentName:"ul"},"Configure admins"))),(0,a.kt)("li",{parentName:"ul"},"Repository configuration")),(0,a.kt)("h2",{id:"creating-organisations"},"Creating Organisations"),(0,a.kt)("p",null,"Creating organisations is not available via the Terraform provider."),(0,a.kt)("p",null,"This has to be done ",(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/enterprise-server@3.0/rest/reference/enterprise-admin#create-an-organization"},"via the API"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'curl \\\n  -X POST \\\n  -H "Accept: application/vnd.github.v3+json" \\\n  http(s)://{hostname}/api/v3/admin/organizations \\\n  -d \'{"login":"login","admin":"admin"}\'\n')),(0,a.kt)("p",null,"Success Response: ",(0,a.kt)("inlineCode",{parentName:"p"},"Status: 201 Created")),(0,a.kt)("h2",{id:"user--group-management"},"User / Group Management"),(0,a.kt)("p",null,"Users and group can be ",(0,a.kt)("a",{parentName:"p",href:"https://jakenelson.cloud/docs/tech/github/syncing-github-groups-from-azuread/"},"synced from azure-ad")," or configured statically."),(0,a.kt)("h3",{id:"creating-org-admins"},"Creating org admins"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'resource "github_membership" "membership_for_some_user" {\n  username = "SomeUser"\n  role     = "admin"\n}\n')),(0,a.kt)("h3",{id:"blocking-users"},"Blocking Users"),(0,a.kt)("p",null,"Whilst uncommon it might be required to occasionally block members."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'resource "github_organization_block" "example" {\n  username = "paultyng"\n}\n')),(0,a.kt)("h2",{id:"repository-management"},"Repository Management"),(0,a.kt)("p",null,"A repository module should be used to ensure that ",(0,a.kt)("a",{parentName:"p",href:"https://jakenelson.cloud/docs/tech/github/github-repository-best-practices/"},"repository best practices")," are being adhered to."),(0,a.kt)("p",null,"Use repository templates to consume best practice repos, potentially including things like doc templates and Codeowners."),(0,a.kt)("p",null,"The option to destroy repositories should be very carefully restricted, probably disallowed entirely via (make destroyed archived)."),(0,a.kt)("p",null,"Template repositories can be managed via code as well."),(0,a.kt)("h2",{id:"enterprise-code-directory-structures"},"Enterprise Code Directory Structures"),(0,a.kt)("h3",{id:"separate-orgs"},"Separate Orgs"),(0,a.kt)("h4",{id:"pros"},"Pros"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Ideal for improving separation between organisations."),(0,a.kt)("li",{parentName:"ul"},"Reduces risk of impacting another organisation."),(0,a.kt)("li",{parentName:"ul"},"All resources defined in Terraform files can be easier to read.")),(0,a.kt)("h4",{id:"cons"},"Cons"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Is not DRY - lots of code duplication for each organisation."),(0,a.kt)("li",{parentName:"ul"},"Can be difficult to maintain."),(0,a.kt)("li",{parentName:"ul"},"Ambiguous as to who's responsibility it is to maintain the directory (i.e. Github team that own this repo or the organisation owners)")),(0,a.kt)("h4",{id:"structure"},"Structure"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},".\n\u251c\u2500\u2500 CODEOWNERS\n\u251c\u2500\u2500 modules\n\u2502   \u2514\u2500\u2500 membership\n\u2502       \u251c\u2500\u2500 examples\n\u2502       \u2502   \u251c\u2500\u2500 common-org\n\u2502       \u2502   \u2502   \u251c\u2500\u2500 main.tf\n\u2502       \u2502   \u2502   \u2514\u2500\u2500 versions.tf\n\u2502       \u2502   \u2514\u2500\u2500 edge-case-org\n\u2502       \u2502       \u251c\u2500\u2500 main.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u251c\u2500\u2500 main.tf\n\u2502       \u251c\u2500\u2500 test\n\u2502       \u2502   \u251c\u2500\u2500 terraform_common_org_test.go\n\u2502       \u2502   \u2514\u2500\u2500 terraform_edge_case_org_test.go\n\u2502       \u251c\u2500\u2500 variable.tf\n\u2502       \u2514\u2500\u2500 variables.tf\n\u251c\u2500\u2500 orgs\n\u2502   \u251c\u2500\u2500 github-management\n\u2502   \u2502   \u251c\u2500\u2500 members.tf\n\u2502   \u2502   \u251c\u2500\u2500 repositories.tf\n\u2502   \u2502   \u251c\u2500\u2500 variables.tf\n\u2502   \u2502   \u2514\u2500\u2500 versions.tf\n\u2502   \u251c\u2500\u2500 org-2\n\u2502   \u2502   \u251c\u2500\u2500 members.tf\n\u2502   \u2502   \u251c\u2500\u2500 repositories.tf\n\u2502   \u2502   \u251c\u2500\u2500 variables.tf\n\u2502   \u2502   \u2514\u2500\u2500 versions.tf\n\u2502   \u2514\u2500\u2500 orgs\n\u2514\u2500\u2500 pipelines\n    \u251c\u2500\u2500 support-import-resources.yaml\n    \u251c\u2500\u2500 cd-new-org.yaml\n    \u251c\u2500\u2500 cd-org-management.yaml\n    \u251c\u2500\u2500 ci-new-org.yaml\n    \u2514\u2500\u2500 ci-org-management.yaml\n")),(0,a.kt)("h2",{id:"ci--cd"},"CI / CD"),(0,a.kt)("h3",{id:"pipeline-practices"},"Pipeline Practices"),(0,a.kt)("p",null,"Should use a Terraform version greater than 0.13 as it supports Terraform Variable validation out of the box."),(0,a.kt)("h3",{id:"pipeline-authentication"},"Pipeline Authentication"),(0,a.kt)("p",null,"Use a token instead of a Github app to authenticate."),(0,a.kt)("p",null,"This is because Github Apps have limitations around access-management & team membership that requires manual intervention by a organisation admin."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'provider "github" {\n  token = var.token # or `GITHUB_TOKEN`\n}\n')),(0,a.kt)("p",null,"or"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'provider "github" {\n  app_auth {} # When using `GITHUB_APP_XXX` environment variables\n}\n')),(0,a.kt)("h2",{id:"resources"},"Resources"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://registry.terraform.io/providers/integrations/github/latest/docs"},"Github Terraform Provider"))))}c.isMDXComponent=!0}}]);