<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://jakenelson.cloud/blog</id>
    <title>Jake Nelson Blog</title>
    <updated>2022-07-08T14:33:01.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://jakenelson.cloud/blog"/>
    <subtitle>Jake Nelson Blog</subtitle>
    <icon>https://jakenelson.cloud/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Github As Code]]></title>
        <id>github-enterprise-as-code</id>
        <link href="https://jakenelson.cloud/blog/github-enterprise-as-code"/>
        <updated>2022-07-08T14:33:01.000Z</updated>
        <summary type="html"><![CDATA[Status: Work in Progress]]></summary>
        <content type="html"><![CDATA[<div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p><strong>Status:</strong> Work in Progress</p></div></div><p>Having Github managed as code for an entire organisation has several benefits:</p><ul><li>You can define a set of guidelines for creating new resources based on Github best practices. (see resources section)</li><li>Configuration can be as generic or specific as you need for the case.</li><li>Implementation is declaritive and transparent.</li><li>Largely self-service environment reduces TOIL.</li></ul><p>The target of this implementation is large enterprise implementations of Github Enterprise.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="moduleabstraction-use-cases">Module/Abstraction Use Cases<a class="hash-link" href="#moduleabstraction-use-cases" title="Direct link to heading">​</a></h2><ul><li>Organisation group/user management (membership)<ul><li>Handle sync groups or static groups</li><li>Configure admins</li></ul></li><li>Repository configuration</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-organisations">Creating Organisations<a class="hash-link" href="#creating-organisations" title="Direct link to heading">​</a></h2><p>Creating organisations is not available via the Terraform provider.</p><p>This has to be done <a href="https://docs.github.com/en/enterprise-server@3.0/rest/reference/enterprise-admin#create-an-organization" target="_blank" rel="noopener noreferrer">via the API</a>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -X POST </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -H </span><span class="token string" style="color:rgb(255, 121, 198)">"Accept: application/vnd.github.v3+json"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">://</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">hostname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">/api/v3/admin/organizations </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  -d </span><span class="token string" style="color:rgb(255, 121, 198)">'{"login":"login","admin":"admin"}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Success Response: <code>Status: 201 Created</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="user--group-management">User / Group Management<a class="hash-link" href="#user--group-management" title="Direct link to heading">​</a></h2><p>Users and group can be <a href="https://jakenelson.cloud/docs/tech/github/syncing-github-groups-from-azuread/" target="_blank" rel="noopener noreferrer">synced from azure-ad</a> or configured statically.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-org-admins">Creating org admins<a class="hash-link" href="#creating-org-admins" title="Direct link to heading">​</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resource "github_membership" "membership_for_some_user" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  username = "SomeUser"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  role     = "admin"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blocking-users">Blocking Users<a class="hash-link" href="#blocking-users" title="Direct link to heading">​</a></h3><p>Whilst uncommon it might be required to occasionally block members.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resource "github_organization_block" "example" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  username = "paultyng"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="repository-management">Repository Management<a class="hash-link" href="#repository-management" title="Direct link to heading">​</a></h2><p>A repository module should be used to ensure that <a href="https://jakenelson.cloud/docs/tech/github/github-repository-best-practices/" target="_blank" rel="noopener noreferrer">repository best practices</a> are being adhered to.</p><p>Use repository templates to consume best practice repos, potentially including things like doc templates and Codeowners.</p><p>The option to destroy repositories should be very carefully restricted, probably disallowed entirely via (make destroyed archived).</p><p>Template repositories can be managed via code as well.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enterprise-code-directory-structures">Enterprise Code Directory Structures<a class="hash-link" href="#enterprise-code-directory-structures" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="separate-orgs">Separate Orgs<a class="hash-link" href="#separate-orgs" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pros">Pros<a class="hash-link" href="#pros" title="Direct link to heading">​</a></h4><ul><li>Ideal for improving separation between organisations.</li><li>Reduces risk of impacting another organisation.</li><li>All resources defined in Terraform files can be easier to read.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cons">Cons<a class="hash-link" href="#cons" title="Direct link to heading">​</a></h4><ul><li>Is not DRY - lots of code duplication for each organisation.</li><li>Can be difficult to maintain.</li><li>Ambiguous as to who's responsibility it is to maintain the directory (i.e. Github team that own this repo or the organisation owners)</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="structure">Structure<a class="hash-link" href="#structure" title="Direct link to heading">​</a></h4><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── CODEOWNERS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── modules</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   └── membership</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       ├── examples</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │   ├── common</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">org</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │   │   ├── main.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │   │   └── versions.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │   └── edge</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">case</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">org</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │       ├── main.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │       └── versions.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       ├── main.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       ├── test</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │   ├── terraform_common_org_test.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       │   └── terraform_edge_case_org_test.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       ├── variable.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       └── variables.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── orgs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">management</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   ├── members.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   ├── repositories.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   ├── variables.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   └── versions.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── org</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   ├── members.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   ├── repositories.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   ├── variables.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   └── versions.tf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   └── orgs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└── pipelines</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├── support</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">import</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">resources.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├── cd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">org.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├── cd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">org</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">management.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├── ci</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">org.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    └── ci</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">org</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">management.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ci--cd">CI / CD<a class="hash-link" href="#ci--cd" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pipeline-practices">Pipeline Practices<a class="hash-link" href="#pipeline-practices" title="Direct link to heading">​</a></h3><p>Should use a Terraform version greater than 0.13 as it supports Terraform Variable validation out of the box.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pipeline-authentication">Pipeline Authentication<a class="hash-link" href="#pipeline-authentication" title="Direct link to heading">​</a></h3><p>Use a token instead of a Github app to authenticate.</p><p>This is because Github Apps have limitations around access-management &amp; team membership that requires manual intervention by a organisation admin.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">provider "github" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  token = var.token </span><span class="token comment" style="color:rgb(98, 114, 164)"># or `GITHUB_TOKEN`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">provider "github" </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  app_auth </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># When using `GITHUB_APP_XXX` environment variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://registry.terraform.io/providers/integrations/github/latest/docs" target="_blank" rel="noopener noreferrer">Github Terraform Provider</a></li></ul>]]></content>
        <author>
            <name>Jake Nelson</name>
            <uri>https://github.com/Jake-Mok-Nelson</uri>
        </author>
        <category label="github" term="github"/>
        <category label="ghe" term="ghe"/>
        <category label="terraform" term="terraform"/>
    </entry>
</feed>