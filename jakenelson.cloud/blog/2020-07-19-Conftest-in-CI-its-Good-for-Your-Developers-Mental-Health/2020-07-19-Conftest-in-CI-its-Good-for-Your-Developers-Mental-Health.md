---
slug: conftest-in-ci-54503226c225
title: Conftest in CI, it’s Good for Your Developers’ Mental Health
authors: [jake]
tags: [ci, continuous-integration, conftest]
---


![](https://cdn-images-1.medium.com/max/800/0*7G4BBkTWwy5Cou-h)

Errors are stressful, especially when they aren’t meaningful and early.

#### What’s the Issue We’re Trying to Solve?

In modern agile landscapes where developers and operations work together, there’s a big issue and that is the lack of clear communications.

How often do you see an error or failure only to think to yourself “but… I didn’t change anything!”, a ticket and a headache later you realize that the cluster has changed not your application and you weren’t notified. There are changes happening all the time, how would a platform engineer even notify a developer of so many changes?

![](https://cdn-images-1.medium.com/max/800/0*HWt6I0Yw3yeBCmmT)

If there is a new security requirement at the cluster level, how is that communicated to the app-teams and then enforced without failures and delays?

We really need everyone on board and solve the problem together and we can do this by defining our security requirements as rules and using a fantastic tool called Conftest to validate them.

If you or your colleagues come up with a new security rule that is to be enforced in your environment, **where is the rule configured and who owns it?**

Does it belong with the cluster to ensure we don’t breach our policies, outside the cluster to ensure new deployments meet our requirements, or with the application teams to ensure best practices are set from the beginning?

![](https://cdn-images-1.medium.com/max/800/1*CHaSdI1OYYkLOx6NlUuIjA.png)

### What is Conftest?

I can’t say it better than some authors.

> Conftest is a utility to help you write tests against structured configuration data. For instance you could write tests for your Kubernetes configurations, or Tekton pipeline definitions, Terraform code, Serverless configs or any other structured data.

### How does Conftest Solve Our Dilemma?

[Conftest](https://www.conftest.dev/) will test the data you provide it (Dockerfiles, Kubernetes manifests, etc) and compare it against rules written in the [rego language used by Open Policy Agent](https://www.openpolicyagent.org/docs/latest/policy-language/).

By default Conftest will check the current working directory for a sub-directory named “policy”, rules in here will be evaluated against the data you’re testing.

![](https://cdn-images-1.medium.com/max/800/1*rknbsX6C2Tn4FHnQFZv_xQ.png)

We can just write a rego rule for new security requirements and apply it to things running in the cluster but that would break anything already running that doesn’t adhere to our security rules.

**How do we solve this?** We can take it outside the cluster to the manifests that are generated by app-teams, platform engineers, etc, and get deployed to the cluster. This means that when an app-team or dev tries to create a new manifest or make a change to their manifest that doesn’t meet our requirements, CI will fail and they won’t be allowed to deploy it.

We can take it even further and check within the application repos themselves. We can test Dockerfiles before an image is even built as part of CI. You might consider it duplication, I consider it education.

You could share a security rules repository between teams that includes rules for all different types of input you want checked and get cross-team peer reviews. You’ve now got your developers, platform engineers, and security partners at all levels understanding your rules, errors are meaningful right from the start, and are checked in multiple places incase something slips through.

### Kubernetes Manifest Example

Let’s create a test that validates that a manifest about to be deployed to our cluster meets our new security requirement of not running as root!

#### Step 1 — Create the helper functions

Create the helper functions you need in rego under the policy directory. I’ve pinched mine from the great work that already exists over [here](https://github.com/open-policy-agent/conftest/tree/master/examples/kubernetes/policy).

In this example, we’re using some basic helpers like:

package kubernetes

is\_service {  
  input.kind = "Service"  
}

is\_deployment {  
  input.kind = "Deployment"  
}

This can be saved as policy/kubernetes.rego

We can use these helpers to evaluate what kind of resource we’re testing.

#### Step 2 — Create the rule
```
package main   
# the namespace our check lives under

import data.kubernetes   
# importing the helper functions in the kubernetes namespace

name = input.metadata.name   
# a shortcut we can use to easily access the name in our deny messages

deny[msg] {  
  kubernetes.is\_deployment   
  # helper function from kubernetes.rego  
    
  not input.spec.template.spec.securityContext.runAsNonRoot   
  # runAsNonRoot must be present and set to true

msg = sprintf("Containers must not run as root in Deployment %s", \[name\])   
  # if the testing target is a deployment but the second rule evaluates to false, we will return the message as a  build failure  
}
```
We can save this as a policy/deployment.dart so we have a place to store all our deployment based rules.

In the above diagram, we are choosing to use a “deny” because it suits what we’re doing but we could also use “violation” or “warn”.

This is the rule itself, within the deny section the line “_kubernetes.is\_deployment_” will evaluate to true when we’re testing a deployment and the line “_not input.spec.template.spec.securityContext.runAsNonRoot_” will evaluate to true when runAsNonRoot is either not defined or set to false; yeah I know the double negative behavior looks weird.

When all lines of the deny rule evaluate to true, the deny rule returns a failure with the message from the “msg” line at the bottom.

#### Step 3 — Create the manifest

Now create the Kubernetes deployment manifest as deployment.yaml:
```
apiVersion: apps/v1  
kind: Deployment  
metadata:  
  name: hello-kubernetes  
spec:  
  replicas: 3  
  selector:  
    matchLabels:  
      app: hello-kubernetes  
  template:  
    metadata:  
      labels:  
        app: hello-kubernetes  
    spec:  
      # if runAsNonRoot is missing or  
      # false, we will receive a build failure  
      securityContext:  
        runAsNonRoot: false  
      containers:  
      - name: hello-kubernetes  
        image: paulbouwer/hello-kubernetes:1.5  
        ports:  
        - containerPort: 8080
```
#### Step 4 — Run the test

Make sure you have [Conftest installed](https://www.conftest.dev/install/) on your device and run conftest against the deployment manifest, like so:

`› conftest test deployment.yaml`

Note that while we’re doing this from the command line in this test, we can do it the same way in a build step by consuming the [instrumenta/conftest Docker repository](https://hub.docker.com/r/instrumenta/conftest).

Either way, You’ll probably get a failure like this:

FAIL - deployment.yaml - Containers must not run as root in Deployment hello-kubernetes

This is because whilst we are defining the runAsNonRoot securityContext field we aren’t setting it to true.

Try setting it to true and running the test again:

runAsNonRoot: true

You should now see a pass like this:

PASS - deployment.yaml - data.main.deny

### Conclusion

Use it everywhere you can!

Use it on your:

*   OPA config for running containers
*   Manifests pre-deployment
*   Application build time CI

This helps ensure that meaningful errors get to those that are responsible for implementing fixing them right from the start.

Don’t wait for a failure in the cluster followed by a help-desk ticket! C’mon, we can do better than that!

![](https://cdn-images-1.medium.com/max/800/1*LBeG0mvq9MM2k1cUyS6mgQ.png)
![](https://cdn-images-1.medium.com/max/800/0*Piks8Tu6xUYpF4DU)

**Subscribe to** [**FAUN topics**](https://www.faun.dev/join?utm_source=medium.com/faun&utm_medium=medium&utm_campaign=faunmediumprebanner) **and get your weekly curated email of the must-read tech stories, news, and tutorials** 🗞️

**Follow us on** [**Twitter**](https://twitter.com/joinfaun) 🐦 **and** [**Facebook**](https://www.facebook.com/faun.dev/) 👥 **and** [**Instagram**](https://instagram.com/fauncommunity/) 📷 **and join our** [**Facebook**](https://www.facebook.com/groups/364904580892967/) **and** [**Linkedin**](https://www.linkedin.com/company/faundev) **Groups** 💬

[![](https://cdn-images-1.medium.com/max/2560/1*_cT0_laE4iPcqW1qrbstAg.gif)](https://www.faun.dev/join?utm_source=medium.com/faun&utm_medium=medium&utm_campaign=faunmediumbanner)

#### If this post was helpful, please click the clap 👏 button below a few times to show your support for the author! ⬇